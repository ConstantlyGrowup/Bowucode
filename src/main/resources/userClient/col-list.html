<!doctype html>
<html lang="zh-CN">
	<head>
		<!-- Required meta tags -->
        <meta charset="UTF-8">
        <title>"黑悟空"主题数字文旅平台</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="HandheldFriendly" content="True">
		<!-- Bootstrap v4.3.1 CSS -->
		<link rel="stylesheet" href="lib/bootstrap/css/bootstrap.min.css">
		<!-- Custom CSS -->
		<link rel="stylesheet" href="css/normalize.css">
		<link rel="stylesheet" href="css/theme.css">
		<!-- Slick CSS -->
		<link rel="stylesheet" type="text/css" href="lib/slick/slick/slick.css">
		<link rel="stylesheet" type="text/css" href="lib/slick/slick/slick-theme.css">
		<!-- Magnific Popup core CSS file -->
		<link rel="stylesheet" href="lib/Magnific-Popup-master/dist/magnific-popup.css">
		<!-- Font Awesome Free 5.10.2 CSS JS -->
		<link href="lib/fontawesome-free-5.10.2-web/css/all.css" rel="stylesheet">
        <link href="lib/elementui/emui_index.css" rel="stylesheet" type="text/css" />
        <script defer src="lib/fontawesome-free-5.10.2-web/js/brands.js"></script>
        <script defer src="lib/fontawesome-free-5.10.2-web/js/solid.js"></script>
        <script defer src="lib/fontawesome-free-5.10.2-web/js/fontawesome.js"></script>
        <script defer src="lib/elementui/emui_index.js"></script>
        <script src="./util/vue.js"></script>
        <script src="./util/axios.js"></script>
        <script src="./util/request.js"></script>
	</head>
<body class="default">
	<div id="app">
		<div class="preloading">
			<div class="wrap-preload">
				<div class="cssload-loader"></div>
			</div>
		</div>
		<!-- Header  -->
		<nav class="navbar navbar-expand-lg navbar-light bg-header">
			<div class="container-fluid">
				<div class="logo">"黑悟空"主题数字文旅平台</div>
			</div>
		</nav>
		<!-- .Header  -->
		<!-- Content  -->
		<div class="content">
			<div class="content-wrap page-news-list">
				<div class="subsite-banner">

					<img src="img/subtitle-collection.jpg">
				</div>
				<div class="subsite subsite-with-banner">
					<div class="row">
						<div class="col-md-12">
							<div class="subsite-heading">
								藏品列表
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12">
							<div class="search-form search-content">
								<select class="custom-select mr-sm-2 with-icon" id="caravailable" v-model="queryInfo.cateId">
									<option value="">全部分类</option>
									<option :value="item.dicValue" v-for="item in colTyps">{{item.dicValue}}</option>
								</select>
								<div class="search-wrapper ">
									<input id="search" placeholder="请输入标题" v-model="queryInfo.name">
									<button class="ssubmit" type="button" name="search_submit" @click="getColDataList()"><i class="fas fa-search"></i></button>
								</div>
							</div>
						</div>
					</div>
					<div class="row news-row" v-for="item in collectionData">
						<div class="col-md-12">
							<a :href="'collDetail.html?id='+ item.id">
								<div class="news-card">
									<div class="nc-top">
										<div class="nc-left">
											<div class="ncl-image">
												<img :src="'http://localhost:8090/api/file/getPic?name=' + item.colPic" alt="image">
											</div>
										</div>
										<div class="nc-right">
											<div class="ncr-row-a">
												{{item.title}}
											</div>
											<div class="ncr-row-b">
												<p v-html="item.desColl"></p>
											</div>
										</div>
									</div>
								</div>
							</a>
						</div>
					</div>
					<!-- 添加分页控件 -->
					<div class="pagination-container" style="text-align: center; margin-top: 20px; margin-bottom: 70px;">
						<span class="page-info" style="margin-right: 10px;">第 {{queryInfo.pagenum}} 页</span>
						<button class="theme-button" @click="prevPage" :disabled="queryInfo.pagenum <= 1">上一页</button>
						<button class="theme-button" @click="nextPage" :disabled="!hasNextPage">下一页</button>
					</div>
				</div>
			</div>
		</div>
		<!-- .Content  -->
		<!-- 底部面板  -->
		<div class="bottom-panel">
			<div class="bp-col">
				<a href="index.html">
					<div class="bp-icon"><img src="img/iphome.png" alt="icon"> </div>
					<div class="bp-text">首页</div>
				</a>
			</div>
			<div class="bp-col">
				<a href="col-list.html">
					<div class="bp-icon"><img src="img/ipoffer2.png" alt="icon"></div>
					<div class="selected-bottom-text">藏品</div>
				</a>
			</div>
			<div class="bp-col">
				<a href="ReserveDetail.html">
					<div class="bp-icon"><img src="img/ipcar.png" alt="icon"></div>
					<div class="bp-text">我的预约</div>
				</a>
			</div>
			<div class="bp-col">
				<a href="setting.html">
					<div class="bp-icon"><img src="img/ipaccount.png" alt="icon"></div>
					<div class="bp-text">个人中心</div>
				</a>
			</div>
		</div>
		<!-- .Bottom Panel  -->
		<div class="overlay"></div>
		<!-- Optional JavaScript -->
		<!-- jQuery v3.4.1 -->
		<script src="lib/jquery/jquery-3.4.1.min.js"></script>
		<!--  Bootstrap v4.3.1 JS -->
		<script src="lib/bootstrap/js/bootstrap.min.js"></script>
		<!-- Magnific Popup core JS file -->
		<script src="lib/Magnific-Popup-master/dist/jquery.magnific-popup.js"></script>
		<!-- Slick JS -->
		<script src="lib/slick/slick/slick.min.js"></script>
		<!--  Custom JS -->
		<script src="js/theme.js"></script>
		<script>
			const vm = new Vue({
				el: '#app',
				data: {
					colTyps : [],
					collectionData : [],
					userInfo: null,
					queryInfo: {
						pagenum: 1,
						pagesize: 8,
						name: '',
						cateId: ''
					},
					total: 0,
					hasNextPage: true
				},
				created() {
					// 先检查用户状态
					this.checkUserStatus();
					console.log('Vue instance created');
					// 从URL获取分类参数
					const typ = getQueryString('type')
					if (typ) {
						// 对URL参数进行解码，确保中文等特殊字符被正确解析
						this.queryInfo.cateId = decodeURIComponent(typ)
						console.log('获取到分类参数:', this.queryInfo.cateId)
					}
					this.getColDataList()
					this.listDicByTyp()
				},
				methods: {
					async checkUserStatus() {
						try {
							const token = sessionStorage.getItem('token');
							console.log('当前token:', token);
							if (token) {
								const response = await get('/user/me');
								if (response.code === 200 && response.data) {
									this.userInfo = response.data;
									console.log('用户信息获取成功:', this.userInfo);
								}
							}
						} catch (err) {
							console.error('获取用户信息失败:', err);
						}
					},
					listDicByTyp() {
						post('dic/listColType', {dicTyp: '藏品分类'}).then(response => {
							this.colTyps = response.data;
						}).catch(err => {
							console.log(err);
						});
					},
					getColDataList() {
						// 确保查询条件中包含了搜索关键词
						console.log('搜索关键词:', this.queryInfo.name);
						console.log('查询条件:', this.queryInfo);
						
						post('/collect/getdataList', this.queryInfo).then(response => {
							if (response.code === 200) {
								this.collectionData = response.data.list;
								this.total = response.data.total || 0;
								// 计算是否有下一页
								this.hasNextPage = this.queryInfo.pagenum * this.queryInfo.pagesize < this.total;
							} else {
								console.error('获取藏品数据失败:', response.msg);
							}
						}).catch(err => {
							console.log(err);
						});
					},
					// 监听分类选择变化
					handleCategoryChange() {
						this.queryInfo.pagenum = 1; // 切换分类时重置到第一页
						this.getColDataList();
					},
					// 上一页
					prevPage() {
						if (this.queryInfo.pagenum > 1) {
							this.queryInfo.pagenum--;
							this.getColDataList();
						}
					},
					// 下一页
					nextPage() {
						if (this.hasNextPage) {
							this.queryInfo.pagenum++;
							this.getColDataList();
						}
					}
				},
				watch: {
					// 监听分类选择变化
					'queryInfo.cateId': function(newVal, oldVal) {
						if (newVal !== oldVal) {
							this.handleCategoryChange();
						}
					}
				}
			})
		</script>
	</div>
</body>
</html>
