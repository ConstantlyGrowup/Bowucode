# 新闻推送系统 API 接口文档

## 系统概述

新闻推送系统是一个基于Redis的新闻数据管理平台，主要用于接收、存储和分发新闻数据。系统采用批次管理机制，支持历史数据累积存储和高效查询。

### 核心业务逻辑

1. **周期性数据推送**：工作流每周推送一批新闻数据，包含该周收集的所有新闻条目
2. **批次唯一性管理**：每个批次具有唯一ID和时间戳，系统自动检测并拒绝重复推送
3. **历史数据累积**：系统累积存储所有历史批次，不会覆盖已有数据
4. **智能缓存策略**：自动维护最新新闻缓存，优化客户端查询性能
5. **数据生命周期管理**：所有数据设置7天过期时间，支持自动清理

## 数据模型

### NewsBatch（新闻批次）
```json
{
  "BatchId": "BatchID-5rpukqr0-1757560784662",    // 批次唯一标识
  "BatchTime": "2025-01-11T11:18:52.308+08:00",   // 批次时间戳
  "Items": [                                       // 新闻条目列表
    {
      "ItemId": "item-9eibsdmv-1757559891950",     // 新闻条目ID
      "Title": "新闻标题",                          // 新闻标题
      "Content": "新闻内容摘要",                    // 新闻内容摘要
      "NewsDate": "2025-01-10 20:06:00",          // 新闻发布时间
      "Media": "媒体来源",                         // 媒体来源
      "Link": "https://example.com/news1"         // 新闻链接
    }
  ]
}
```

## API 接口详情

### 1. 新闻数据推送接口

**接口地址**: `POST /news/push`

**业务逻辑**：
- 接收工作流推送的新闻批次数据
- 验证批次ID的唯一性，拒绝重复推送
- 将批次数据存储到Redis，设置7天过期时间
- 更新批次列表和最新新闻缓存
- 支持事务性操作，确保数据一致性

**请求参数**：
- **Content-Type**: `application/json`
- **请求体**: NewsBatch数组（通常只包含一个批次）

**请求示例**：
```json
[
  {
    "BatchId": "BatchID-5rpukqr0-1757560784662",
    "BatchTime": "2025-01-11T11:18:52.308+08:00",
    "Items": [
      {
        "ItemId": "item-9eibsdmv-1757559891950",
        "Title": "为什么阅兵一定要走分列式？",
        "Content": "本文探讨了阅兵分列式的起源、发展及其在中国人民军队中的演变。",
        "NewsDate": "2025-01-10 20:06:00",
        "Media": "国家人文历史",
        "Link": "https://example.com/news1"
      },
      {
        "ItemId": "item-lx0jrucd-1757559891950",
        "Title": "修奇迹之桥，排死亡炸弹：九三阅兵中的蓝盔方阵背后有多少故事？",
        "Content": "在纪念中国人民抗日战争暨世界反法西斯战争胜利80周年阅兵式上，",
        "NewsDate": "2025-01-10 12:25:00",
        "Media": "国家人文历史",
        "Link": "https://example.com/news2"
      }
    ]
  }
]
```

**成功响应**：
```json
{
  "code": 200,
  "msg": "成功",
  "data": "新闻数据推送成功"
}
```

**业务异常响应**：
```json
{
  "code": 100,
  "msg": "批次已存在，拒绝重复推送: BatchID-5rpukqr0-1757560784662",
  "data": null
}
```

**系统异常响应**：
```json
{
  "code": 100,
  "msg": "新闻数据推送失败: Redis连接异常",
  "data": null
}
```

### 2. 获取最新新闻数据接口

**接口地址**: `GET /news/list`

**业务逻辑**：
- 从Redis缓存中获取最新的新闻数据
- 返回最近5个批次的历史数据，按时间倒序排列
- 如果缓存不存在，自动重新构建缓存
- 优化客户端展示性能，避免频繁查询大量历史数据

**请求参数**：无

**响应示例**：
```json
{
  "code": 200,
  "msg": "成功",
  "data": [
    {
      "BatchId": "BatchID-5rpukqr0-1757560784662",
      "BatchTime": "2025-01-11T11:18:52.308+08:00",
      "Items": [
        {
          "ItemId": "item-9eibsdmv-1757559891950",
          "Title": "为什么阅兵一定要走分列式？",
          "Content": "本文探讨了阅兵分列式的起源、发展及其在中国人民军队中的演变。",
          "NewsDate": "2025-01-10 20:06:00",
          "Media": "国家人文历史",
          "Link": "https://example.com/news1"
        }
      ]
    }
  ]
}
```

**空数据响应**：
```json
{
  "code": 200,
  "msg": "成功",
  "data": []
}
```

### 3. 根据批次ID查询新闻数据接口

**接口地址**: `GET /news/batch/{batchId}`

**业务逻辑**：
- 根据批次ID精确查询特定批次的新闻数据
- 支持历史批次数据查询，不受最新缓存限制
- 提供完整的批次信息，包括所有新闻条目
- 用于详细查看和历史数据回溯

**路径参数**：
- `batchId`: 批次ID（String，必填）

**请求示例**：
```
GET /news/batch/BatchID-5rpukqr0-1757560784662
```

**成功响应**：
```json
{
  "code": 200,
  "msg": "成功",
  "data": {
    "BatchId": "BatchID-5rpukqr0-1757560784662",
    "BatchTime": "2025-01-11T11:18:52.308+08:00",
    "Items": [
      {
        "ItemId": "item-9eibsdmv-1757559891950",
        "Title": "为什么阅兵一定要走分列式？",
        "Content": "本文探讨了阅兵分列式的起源、发展及其在中国人民军队中的演变。",
        "NewsDate": "2025-01-10 20:06:00",
        "Media": "国家人文历史",
        "Link": "https://example.com/news1"
      }
    ]
  }
}
```

**数据不存在响应**：
```json
{
  "code": 100,
  "msg": "未找到指定批次的新闻数据",
  "data": null
}
```

### 4. 获取所有批次ID列表接口

**接口地址**: `GET /news/batches`

**业务逻辑**：
- 获取系统中所有历史批次的ID列表
- 使用Redis Set数据结构，自动去重
- 支持批次管理和数据统计
- 为客户端提供批次导航功能

**请求参数**：无

**响应示例**：
```json
{
  "code": 200,
  "msg": "成功",
  "data": [
    "BatchID-5rpukqr0-1757560784662",
    "BatchID-4rpukqr0-1757560784661",
    "BatchID-3rpukqr0-1757560784660"
  ]
}
```

**空列表响应**：
```json
{
  "code": 200,
  "msg": "成功",
  "data": []
}
```

## Redis 存储架构

### 存储结构设计

1. **批次数据存储**
   - **Key**: `news:batch:{batchId}`
   - **Type**: String
   - **Value**: JSON序列化的NewsBatch对象
   - **TTL**: 7天

2. **批次ID集合**
   - **Key**: `news:batches`
   - **Type**: Set
   - **Value**: 所有批次ID的集合
   - **TTL**: 7天

3. **最新新闻缓存**
   - **Key**: `news:latest`
   - **Type**: String
   - **Value**: JSON序列化的最新5个批次数组
   - **TTL**: 7天

### 缓存更新策略

1. **推送时更新**：
   - 存储新批次数据到 `news:batch:{batchId}`
   - 添加批次ID到 `news:batches` 集合
   - 重新构建 `news:latest` 缓存

2. **查询时更新**：
   - 如果 `news:latest` 缓存不存在，自动重新构建
   - 按批次时间倒序排列，最多保留5个批次

3. **数据一致性**：
   - 通过批次ID唯一性检查防止重复存储
  

## 错误处理机制

### 业务异常
- **重复推送**: 批次ID已存在时返回错误，避免数据重复
- **数据不存在**: 查询不存在的批次时返回友好提示
- **参数验证**: 批次ID为空或格式错误时返回参数错误

### 系统异常
- **Redis连接异常**: 数据库连接失败时的错误处理
- **JSON序列化异常**: 数据格式错误时的异常处理
- **网络超时**: 请求超时时的重试机制

## 性能优化策略

1. **缓存策略**：
   - 最新新闻数据预缓存，减少查询延迟
   - 7天TTL自动清理过期数据，节省存储空间

2. **查询优化**：
   - 批次ID精确查询，避免全表扫描
   - 限制最新缓存数量，控制内存使用

3. **并发控制**：
   - 批次唯一性检查防止并发重复推送

## 测试验证流程

### 1. 环境准备
- 确保Redis服务正常运行
- 启动Spring Boot应用
- 准备测试数据文件

### 2. 功能测试
1. **推送测试**：使用测试数据推送新闻批次
2. **查询测试**：验证最新新闻数据获取
3. **批次查询**：测试指定批次ID查询
4. **批次列表**：验证所有批次ID获取
5. **重复推送**：测试重复批次ID的拒绝机制

### 3. 异常测试
1. **网络异常**：模拟Redis连接失败
2. **数据格式异常**：发送格式错误的JSON数据
3. **参数异常**：测试空参数和无效参数

### 4. 性能测试
1. **并发推送**：测试多线程同时推送数据
2. **大数据量**：测试大批次数据的处理能力
3. **缓存效果**：验证缓存对查询性能的提升
